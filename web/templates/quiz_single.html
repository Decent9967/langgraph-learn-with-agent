{% extends "base.html" %}

{% block title %}{{ quiz.title }} - {% endblock %}

{% block extra_scripts %}
<script>
const QUIZ_FILE = '{{ quiz_file }}';
let userAnswers = {{ saved_answers | tojson }};
</script>
<script src="{{ url_for('static', filename='js/quiz.js') }}"></script>
{% endblock %}

{% block content %}
<div class="quiz-page" data-quiz-file="{{ quiz_file }}">
    <div class="quiz-header">
        <h1>{{ quiz.title }}</h1>
        <div class="mode-toggle">
            <button class="mode-btn active" onclick="switchMode('single')">ä¸€é¢˜ä¸€é¡µ</button>
            <button class="mode-btn" onclick="switchMode('all')">å…¨éƒ¨æ˜¾ç¤º</button>
        </div>
    </div>

    <div class="quiz-progress">
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
        </div>
        <div class="progress-text">
            <span id="answeredCount">0</span> / <span id="totalCount">{{ quiz.questions | length }}</span> é¢˜
        </div>
    </div>

    <!-- é¢˜ç›®å¯¼èˆªæ ï¼ˆä¸€é¢˜ä¸€é¡µæ¨¡å¼ï¼‰ -->
    <div class="question-nav single-mode-nav" id="questionNav">
        <div style="text-align: center; margin-bottom: 0.5rem; color: var(--text-secondary); font-size: 0.9rem;">
            ç‚¹å‡»é¢˜ç›®ç¼–å·å¿«é€Ÿè·³è½¬
        </div>
        <div class="question-nav-grid" id="questionNavGrid">
            {% for question in quiz.questions %}
            <div class="question-nav-item {% if saved_answers.get(question.id) %}answered{% endif %}"
                 data-question-index="{{ loop.index }}"
                 onclick="goToQuestion({{ loop.index }})">
                {{ loop.index }}
            </div>
            {% endfor %}
        </div>
        <div class="question-nav-buttons">
            <button class="nav-btn" id="prevBtn" onclick="prevQuestion()" disabled>â† ä¸Šä¸€é¢˜</button>
            <span class="nav-info" id="navInfo">1 / {{ quiz.questions | length }}</span>
            <button class="nav-btn" id="nextBtn" onclick="nextQuestion()">ä¸‹ä¸€é¢˜ â†’</button>
        </div>
    </div>

    <div class="questions-container" id="questionsContainer">
        {% for question in quiz.questions %}
        <div class="question-card single-mode {% if loop.first %}active{% endif %}"
             data-question-id="{{ question.id }}"
             data-question-type="{{ question.type }}"
             id="question-{{ loop.index }}">
            <div class="question-header">
                <span class="question-number">é¢˜ç›® {{ question.number }}
                {% if question.type == 'choice' %}
                    <span class="question-type-badge choice">é€‰æ‹©é¢˜</span>
                {% elif question.type == 'open' %}
                    <span class="question-type-badge open">å¼€æ”¾é¢˜</span>
                {% endif %}
                </span>
                <span class="question-status" id="status-{{ question.id }}"></span>
            </div>
            <div class="question-text">{{ question.text }}</div>

            {% if question.type == 'choice' %}
            <div class="question-options">
                {% for letter, text in question.options.items() %}
                <label class="option-label">
                    <input type="radio"
                           name="{{ question.id }}"
                           value="{{ letter }}"
                           {% if saved_answers.get(question.id) == letter %}checked{% endif %}
                           onchange="saveAnswer('{{ question.id }}', '{{ letter }}')">
                    <span class="option-letter">{{ letter }}.</span>
                    <span class="option-text">{{ text }}</span>
                </label>
                {% endfor %}
            </div>

            {% elif question.type == 'open' %}
            <div class="question-open-answer">
                <textarea
                    id="answer-{{ question.id }}"
                    class="open-answer-input"
                    placeholder="å†™ä¸‹ä½ çš„ç†è§£..."
                    rows="4"
                    onchange="saveOpenAnswer('{{ question.id }}', this.value)"
                >{{ saved_answers.get(question.id, '') }}</textarea>
                <button class="btn btn-secondary btn-sm" onclick="toggleExplanation('{{ question.id }}')">
                    <span class="toggle-icon">ğŸ‘ï¸</span> æŸ¥çœ‹ç­”æ¡ˆ
                </button>
                <div class="explanation-box" id="explanation-{{ question.id }}" style="display: none;">
                    <h4>âœ… æ­£ç¡®ç­”æ¡ˆ</h4>
                    <div class="explanation-content">{{ question.explanation | safe }}</div>
                </div>
            </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>

    <div class="quiz-actions">
        <button class="btn btn-secondary" onclick="showQuizList()">è¿”å›åˆ—è¡¨</button>
        <button class="btn btn-success" onclick="submitQuiz()">æäº¤ç­”æ¡ˆ</button>
    </div>

    <!-- ç»“æœå±•ç¤ºåŒºåŸŸ -->
    <div id="resultArea" class="result-area" style="display: none;">
        <h2>ç­”é¢˜ç»“æœ</h2>
        <div class="score-summary" id="scoreSummary"></div>
        <div id="resultDetails"></div>
    </div>
</div>
{% endblock %}
